name: Backend CI/CD

on:
    push:
        branches: [main]
        paths:
            - "backend/**"
            - ".github/workflows/backend-ci.yml"
    pull_request:
        branches: [main]
        paths:
            - "backend/**"

env:
    REGISTRY: ghcr.io
    IMAGE_NAME: ${{ github.repository }}/backend

jobs:
    lint-and-typecheck:
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: ./backend
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"
                  cache-dependency-path: backend/package-lock.json
            - run: npm ci
            - run: npm run typecheck

    build-and-push:
        runs-on: ubuntu-latest
        needs: lint-and-typecheck
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        permissions:
            contents: read
            packages: write
        steps:
            - uses: actions/checkout@v4

            - name: Log in to GitHub Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Extract metadata
              id: meta
              uses: docker/metadata-action@v5
              with:
                  images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
                  tags: |
                      type=sha,prefix={{branch}}-
                      type=ref,event=branch
                      type=raw,value=latest,enable={{is_default_branch}}

            - name: Build and push Docker image
              uses: docker/build-push-action@v5
              with:
                  context: ./backend
                  push: true
                  tags: ${{ steps.meta.outputs.tags }}
                  labels: ${{ steps.meta.outputs.labels }}
